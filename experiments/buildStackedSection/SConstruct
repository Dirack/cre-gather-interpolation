#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# SConstruct  (Madagascar Script)
#
# Purpose: get CRE gather for several m0's and t0's. Save the CRS parameters obtained
# in the optimization step in order to get the radiusgram, anglegram and semblancegram.
#
# Site: http://www.dirackslounge.online
# 
# Version 1.0
#
# Programer: Rodolfo A. C. Neves (Dirack) 27/09/2019
#
# Email: rodolfo_profissional@hotmail.com
#
# License: GPL-3.0 <https://www.gnu.org/licenses/gpl-3.0.txt>.


# Madagascar library
from rsf.proj import *

# Python math library
import math

# Ploting functions
from graph_scons import *

v0 = 1.5
ot0 = 1.4
dt0 = 0.004
nt0 = 4
om0 = 4
dm0 = 0.0125
nm0 = 1

parametersCube = []
creGatherCube = []
creTimeCurveCube = []
creGatherCubeForM0List = []
creTimeCurveCubeForM0List = []
creGatherIndex = 0

for i in range(nm0):

	m0 = om0 + (i * dm0)

	for j in range(nt0):

		t0 = ot0 + (dt0 * j)

		crsParameters = 'crsParameters-m0-%g-t0-%g' % (i,j)
		creMhCoordinates = 'creMhCoordinates-m0-%g-t0-%g' % (i,j)
		creGather = 'creGather-m0-%g-t0-%g' % (i,j)
		creMcoordinate = 'creMcoordinate-m0-%g-t0-%g' % (i,j)
		creTimeCurve = 'creTimeCurve-m0-%g-t0-%g' % (i,j)
		creGatherPlot = 'crePlot-m0-%g-t0-%g' % (i,j)

		# Very Fast Simulated Aneelling Global Optimization (VFSA)
		Flow(crsParameters,'interpolatedDataCube',
			'''
			vfsacrenh m0=%g v0=%g t0=%g verb=y repeat=2
			''' % (m0,v0,t0))

		# Calculate CRE trajectory
		Flow(creMhCoordinates,['interpolatedDataCube',crsParameters],
			'''
			cretrajec verb=y m0=%g param=${SOURCES[1]} |
			put unit1="Offset" label1="Km"
			''' % (m0))

		#Get CRE Gather from interpolated Data Cube
		Flow([creGather,creMcoordinate],['interpolatedDataCube',creMhCoordinates],
			'''
			getcregather verb=y cremh=${SOURCES[1]} m=${TARGETS[1]} |
                        put label1="Time" unit1="s" label2="Offset" unit2="km" |
                        sed "s/n3=//g"
			''')

		# Calculate CRE traveltime curve t(m,h)
		Flow(creTimeCurve,[creMcoordinate, crsParameters],
			'''
			getcretimecurve param=${SOURCES[1]} t0=%g m0=%g v0=%g verb=y |
                        put label1="Offset" unit1="Km" |
                        sed "s/n3=//g;s/n2=//g"
			''' % (t0,m0,v0))


		Plot(creTimeCurve,
			'''
			graph min2=0 max2=2.5 min1=0 max1=0.0125 wanttitle=n symbol=* symbolsz=4 plotcol=3 yreverse=y 
			''')
		Plot(creGather,
			'''
			grey wanttitle=n transp=y yreverse=y wantaxis=n min1=0 max1=2.5 min2=0 max2=0.0125 
			''')
		Result(creGatherPlot,[creGather,creTimeCurve],'Overlay')

		parametersCube.append(crsParameters)
		creGatherCube.append(creGather)
		creTimeCurveCube.append(creTimeCurve)
		creGatherIndex = creGatherIndex + 1

	# Concatenate cre gathers for each m0
	creGatherCubeForM0 = "creGatherCube-m0-%i" % i
	creGatherCubeForM0List.append(creGatherCubeForM0)
	Flow(creGatherCubeForM0,creGatherCube,
		'''
		rcat axis=3 ${SOURCES[1:%d]}
		''' % nt0)

	# Concatenate cre Time curves for each m0
	creTimeCurveCubeForM0 = "creTimeCurveCube-m0-%i" % i
	creTimeCurveCubeForM0List.append(creTimeCurveCubeForM0)
	Flow(creTimeCurveCubeForM0,creTimeCurveCube,
		'''
		rcat axis=2 ${SOURCES[1:%d]}
		'''% nt0)

	creTimeCurveCube = []
	creGatherCube = []

# Get a paramters cube RN, RNIP, BETA, SEMBLANCE
Flow('parametersCube',parametersCube,
	'''
	rcat axis=2 ${SOURCES[1:%d]}
	''' % (creGatherIndex-1))

# Get cre Gathers organized by t0 and m0
Flow('creGatherCube',creGatherCubeForM0List,
	'''
	rcat axis=4 ${SOURCES[1:%d]} |
	put d4=%g o4=%g d3=%g o3=%g
	''' % (nm0,dm0,om0,dt0,ot0))

# Get all the traveltime curves organized by t0 and m0
Flow('creTimeCurveCube',creTimeCurveCubeForM0List,
	'''
	rcat axis=3 ${SOURCES[1:%d]} |
        put label3="m0" unit3="Km" label2="t0" unit2="s" d2=%g o2=%g d3=%g o3=%g
	''' % (nm0,dt0,ot0,dm0,om0))

# CRE stacking
Flow('creStackedSection',['creGatherCube','creTimeCurveCube'],
	'''
	crestack timeCurves=${SOURCES[1]} verb=y |
	put label1=t0 unit1=s label2=m0 unit2=Km
	''')

End()
